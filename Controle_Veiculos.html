<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Veículos</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Estilos gerais, sidebar, cards, etc. */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d; --success-color: #28a745; --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8; --bg-color: #f4f7f6; --sidebar-bg-color: #2c3e50; --sidebar-text-color: #ecf0f1; --sidebar-hover-bg: #34495e; --card-bg-color: #ffffff;
            --text-color: #343a3f; --border-color: #e0e0e0; --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); --input-border: #ced4da; --input-focus-border: #80bdff;
        }
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); font-size: 16px;
        }
        h1, h2, h3 { color: var(--secondary-color); margin-top: 0; margin-bottom: 20px;
        }
        .sidebar { width: 250px; background-color: var(--sidebar-bg-color); color: var(--sidebar-text-color); padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1); flex-shrink: 0; transition: transform 0.3s ease-in-out;
        }
        .sidebar h2 { text-align: center; color: white; margin-bottom: 30px; font-size: 1.8rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 20px; }
        .sidebar ul { list-style: none;
            padding: 0; margin: 0; }
        .sidebar ul li a { display: flex;
            align-items: center; padding: 12px 20px; color: var(--sidebar-text-color); transition: background-color 0.3s ease; font-size: 1.1rem;
        }
        .sidebar ul li a .material-icons { margin-right: 10px;
        }
        .sidebar ul li a:hover, .sidebar ul li a.active { background-color: var(--sidebar-hover-bg);
        }
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto;
        }
        .content-section { display: none;
        }
        .content-section.active { display: block;
        }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color); }
        .card { background-color: var(--card-bg-color); border-radius: 8px; box-shadow: var(--shadow);
            padding: 25px; margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600;
        }
        select, input, textarea { width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid var(--input-border); border-radius: 6px; box-sizing: border-box; font-size: 1rem;
        }
        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer;
            font-weight: bold; font-size: 1rem; transition: background-color 0.3s ease, transform 0.1s ease; display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-primary { background-color: var(--primary-color); color: white;
        }
        .btn-primary:hover { background-color: #0056b3; transform: translateY(-1px);
        }
        .btn-success { background-color: var(--success-color); color: white;
        }
        .btn-success:hover { background-color: #218838; transform: translateY(-1px);
        }
        .btn-danger { background-color: var(--danger-color); color: white;
        }
        .btn-danger:hover { background-color: #c82333; transform: translateY(-1px);
        }
        .btn-warning { background-color: var(--warning-color);
            color: var(--text-color);}
        .btn-warning:hover { background-color: #e0a800; transform: translateY(-1px);
        }
        .btn-secondary { background-color: var(--secondary-color); color: white;
        }
        .btn-secondary:hover { background-color: #5a6268; transform: translateY(-1px);
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px;
        }
        th, td { border: 1px solid var(--border-color); padding: 12px 15px; text-align: left;
            vertical-align: middle; }
        th { background-color: #f2f2f2;
        }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 20px;
        }
        .status-card { padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: white; margin-bottom: 20px; border-left: 5px solid; }
        .status-card h3 { display: flex;
            align-items: center; justify-content: space-between; margin-bottom: 15px; font-size: 1.4rem; }
        .status-badge { display: inline-block;
            padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.85rem; }
        .status-disponivel { border-color: var(--success-color);
        }
        .status-disponivel .status-badge { background-color: var(--success-color); color: white;
        }
        .status-em-uso { border-color: var(--danger-color);
        }
        .status-em-uso .status-badge { background-color: var(--danger-color); color: white;
        }
        .status-reservado { border-color: var(--info-color);
        }
        .status-reservado .status-badge { background-color: var(--info-color); color: white;
        }
        .status-manutencao { border-color: var(--warning-color);
        }
        .status-manutencao .status-badge { background-color: var(--warning-color); color: var(--text-color);
        }
        .card-details p { margin: 5px 0; font-size: 1rem; color: #555;
        }
        .card-details strong { color: var(--text-color);
        }
        .notification { position: fixed; top: 25px; right: 25px; padding: 15px 25px;
            border-radius: 8px; color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.5s ease-in-out; }
        .notification.show { opacity: 1; visibility: visible;
        }
        .notification.success { background-color: var(--success-color);
        }
        .notification.error { background-color: var(--danger-color);
        }
        .notification.info { background-color: var(--info-color);
        }
        #login-container { display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh;
            background-color: var(--bg-color); }
        #login-card { width: 100%; max-width: 400px; padding: 40px;
        }
        #login-card h2 { text-align: center; font-size: 2rem; color: var(--text-color);
        }
        #app-container { display: none; width: 100%; height: 100vh;
        }
        .app-flex { display: flex; height: 100%;
        }
        #header { display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
            background-color: white; border-bottom: 1px solid var(--border-color); }
        #userInfo { margin-right: 20px; font-weight: 500;
        }
        .form-row { display: flex; gap: 15px;
        }
        .form-row > div { flex: 1;
        }
        .form-row input, .form-row select { margin-bottom: 0;
        }
        .data-load-status { text-align: center; margin-top: 20px; font-weight: bold; color: var(--info-color);
        }
        .data-load-status.error { color: var(--danger-color);
        }
        .reservation-notice { background-color: var(--warning-color); color: var(--text-color); padding: 10px; border-radius: 5px; margin-top: 15px;
            font-weight: bold; font-size: 0.9rem; }
        /* ESTILO DO CARD DE INFORMAÇÃO DA RETIRADA/DEVOLUÇÃO (Melhoria 2) */
        .veiculo-info-card { background-color: #e9ecef; border-left: 5px solid var(--info-color);
            padding: 15px; border-radius: 5px; margin-bottom: 20px; display: none; /* Começa escondido */
        }
        .veiculo-info-card p { margin: 5px 0;
            font-weight: bold; }
        .veiculo-info-card span { font-weight: normal; color: #555;
        }
        /* FIM ESTILO DO CARD DE INFORMAÇÃO DA RETIRADA/DEVOLUÇÃO */
        #menu-toggle { display: none;
        }
        @media (max-width: 768px) {
            .app-flex { flex-direction: column;
            }
            .sidebar {
                position: fixed;
                top: 0; left: 0; height: 100%; z-index: 100;
                transform: translateX(-100%);
            }
            .sidebar.open { transform: translateX(0);
            }
            #header { padding: 0 15px;
            }
            #menu-toggle { display: block; background: transparent; border: none;
                font-size: 2rem;
                color: var(--secondary-color); cursor: pointer; padding: 10px 0; }
        }
    </style>
</head>
<body>

    <div id="notification-bar" class="notification"></div>

    <div id="login-container">
        <div id="login-card" class="card">
            <h2>Acessar Sistema</h2>
            <p style="text-align: center; color: #6c757d;">Faça login com sua senha.</p>
            <form id="login-form">
                <label for="loginSenha">Senha:</label>
                <input type="password" id="loginSenha" required placeholder="Digite sua senha">
                <button type="submit" class="btn-primary" style="width: 100%;">Entrar</button>
            </form>
        </div>
    </div>

    <div id="app-container">
        <div class="app-flex">
            <aside id="sidebar" class="sidebar">
                <h2>Sistema Frota</h2>
                <nav>
                    <ul>
                        <li><a href="#" data-section="status" class="active"><span class="material-icons">dashboard</span> Status</a></li>
                        <li><a href="#" data-section="retirada"><span class="material-icons">directions_car</span> Retirada</a></li>
                        <li><a href="#" data-section="devolucao"><span class="material-icons">history</span> Devolução</a></li>
                        <li><a href="#" data-section="reserva"><span class="material-icons">calendar_today</span> Reserva</a></li>
                        <li><a href="#" data-section="proximas-reservas"><span class="material-icons">event</span> Próximas Reservas</a></li>
                        <li><a href="#" data-section="historico"><span class="material-icons">list_alt</span> Histórico</a></li>
                        <li id="admin-menu-item" style="display: none;"><a href="#" data-section="administracao"><span class="material-icons">settings</span> Administração</a></li>
                    </ul>
                </nav>
            </aside>

            <div style="display: flex; flex-direction: column;
                width: 100%;">
                <header id="header">
                    <button id="menu-toggle" class="material-icons">menu</button>
                    <div style="display: flex;
                        align-items: center;">
                        <p id="userInfo" style="margin-right: 20px;
                            font-weight: 500;"></p>
                        <button id="logout-button" class="btn-danger">Sair</button>
                    </div>
                </header>
                <main class="main-content">
                    
                    <section id="status-section" class="content-section active">
                        <div class="section-header"><h2>Status dos Veículos</h2></div>
                        <p id="statusLoadingMessage" class="data-load-status">Carregando dados...</p>
                        <div class="card-grid" id="statusVeiculosGrid">
                        </div>
                    </section>

                    <section id="retirada-section" class="content-section">
                        <div class="section-header"><h2>Registrar Retirada</h2></div>
                        <div class="card">
                            <form id="formRetirada">
                                <label for="motoristaRetirada">Motorista:</label><select id="motoristaRetirada" name="motorista" required></select>
                                
                                <label for="veiculoRetirada">Veículo (Disponíveis):</label><select 
                                    id="veiculoRetirada" name="veiculo" required></select>

                                <div id="veiculoInfoRetirada" class="veiculo-info-card">
                                    <p>Último Registro do Veículo:</p>
                                    <p>KM: <span id="infoKmUltimaDevolucao">N/A</span></p>
                                    <p>Combustível: <span id="infoCombustivelUltimaDevolucao">N/A</span></p>
                                </div>
                                <label for="kmAtual">KM Atual:</label><input type="number" id="kmAtual" placeholder="Informe o KM atual (Deve ser maior ou igual ao último registro)" required>
                                <label for="combustivelRetirada">Nível Combustível (Retirada):</label>
                                <select id="combustivelRetirada" required>
                                    <option value="">Selecione o nível</option>
                                    <option value="Cheio">Cheio</option>
                                    <option value="3/4">3/4</option>
                                    <option value="1/2">1/2</option>
                                    <option value="1/4">1/4</option>
                                    <option value="Reserva">Reserva</option>
                                </select>
                                <label for="destino">Destino:</label><input type="text" id="destino" required placeholder="Ex: Escritório SP, Cliente X">
                                <button type="submit" class="btn-primary" style="width: 100%;">Registrar Retirada</button>
                            </form>
                        </div>
                    </section>

                    <section id="devolucao-section" class="content-section">
                        <div class="section-header"><h2>Registrar Devolução</h2></div>
                        <div class="card">
                            <form id="formDevolucao">
                                <label for="veiculoDevolucao">Veículo (Em Uso):</label><select 
                                    id="veiculoDevolucao" name="veiculo" required></select>
                                
                                <div id="veiculoInfoDevolucao" class="veiculo-info-card">
                                    <p>Informações da Retirada:</p>
                                    <p>Motorista: <span id="infoMotoristaRetirada">N/A</span></p>
                                    <p>KM Retirada: <span id="infoKmRetirada">N/A</span></p>
                                    <p>Comb. Retirada: <span id="infoCombustivelRetirada">N/A</span></p>
                                </div>
                                <label for="kmDevolucao">KM Atual (Devolução):</label><input type="number" id="kmDevolucao" placeholder="Informe o KM atual (Deve ser maior que o KM de retirada)" required>
                                <label for="combustivelDevolucao">Nível Combustível (Devolução):</label>
                                <select id="combustivelDevolucao" required>
                                    <option value="">Selecione o nível</option>
                                    <option value="Cheio">Cheio</option>
                                    <option value="3/4">3/4</option>
                                    <option value="1/2">1/2</option>
                                    <option value="1/4">1/4</option>
                                    <option value="Reserva">Reserva</option>
                                </select>
                                <label for="observacoesDevolucao">Observações (Opcional):</label><textarea id="observacoesDevolucao" rows="3" placeholder="Ex: Necessário lavar, pneu murcho, etc."></textarea>
                                <button type="submit" class="btn-success" style="width: 100%;">Registrar Devolução</button>
                            </form>
                        </div>
                    </section>

                    <section id="reserva-section" class="content-section">
                        <div class="section-header"><h2>Solicitar Reserva</h2></div>
                        <div class="card">
                            <form id="formReserva">
                                <label for="veiculoReserva">Veículo (Disponível/Reservável):</label><select id="veiculoReserva" required></select>
                                <div class="form-row">
                                    <div>
                                        <label for="dataHoraInicioReserva">Início:</label><input type="datetime-local" id="dataHoraInicioReserva" required>
                                    </div>
                                    <div>
                                        <label for="dataHoraFimReserva">Fim:</label><input type="datetime-local" id="dataHoraFimReserva" required>
                                    </div>
                                </div>
                                <label for="motoristaReserva">Motorista:</label><select id="motoristaReserva" required></select>
                                <label for="motivoReserva">Motivo/Destino:</label><input type="text" id="motivoReserva" required placeholder="Ex: Reunião no Cliente Z, Viagem a Trabalho">
                                <button type="submit" class="btn-info" style="width: 100%;">Solicitar Reserva</button>
                            </form>
                        </div>
                    </section>

                    <section id="proximas-reservas-section" class="content-section">
                        <div class="section-header"><h2>Próximas Reservas</h2></div>
                        <p id="reservasLoadingMessage" class="data-load-status">Carregando reservas...</p>
                        <div class="card">
                            <table id="reservasTable">
                                <thead>
                                    <tr>
                                        <th>Veículo</th>
                                        <th>Motorista</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section id="historico-section" class="content-section">
                        <div class="section-header"><h2>Histórico de Movimentações</h2></div>
                        <p id="historicoLoadingMessage" class="data-load-status">Carregando histórico...</p>
                        <div class="card">
                            <table id="historicoTable">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Tipo</th>
                                        <th>Veículo</th>
                                        <th>Motorista</th>
                                        <th>Detalhes</th>
                                        <th>KM</th>
                                        <th style="width: 100px;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section id="administracao-section" class="content-section">
                        <div class="section-header"><h2>Administração</h2></div>

                        <div class="card">
                            <h3>Gestão de Veículos</h3>
                            <form id="formVeiculo">
                                <input type="hidden" id="veiculoIdEdit">
                                <label for="veiculoModelo">Modelo:</label><input type="text" id="veiculoModelo" required placeholder="Ex: Fiat Uno">
                                <label for="veiculoPlaca">Placa:</label><input type="text" id="veiculoPlaca" required maxlength="7" placeholder="Ex: ABC1234">
                                <label for="veiculoCor">Cor:</label><input type="text" id="veiculoCor" required placeholder="Ex: Branco">
                                <label for="veiculoKm">KM Atual (Inicial):</label><input type="number" id="veiculoKm" required value="0" min="0">
                                <label for="veiculoStatus">Status Inicial:</label>
                                <select id="veiculoStatus" required>
                                    <option value="Disponível">Disponível</option>
                                    <option value="Manutenção">Manutenção</option>
                                </select>
                                <button type="submit" class="btn-primary">Salvar Veículo</button>
                                <button type="button" class="btn-secondary" id="cancelarEdicaoVeiculo" style="display: none;">Cancelar Edição</button>
                            </form>
                            <h4 style="margin-top: 20px;">Veículos Cadastrados</h4>
                            <p id="veiculosLoadingMessage" class="data-load-status">Carregando veículos...</p>
                            <table id="veiculosAdminTable">
                                <thead>
                                    <tr><th>Modelo/Placa</th><th>Cor</th><th>KM</th><th>Status</th><th>Ações</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="card" style="margin-top: 25px;">
                            <h3>Gestão de Usuários</h3>
                            <form id="formUsuario">
                                <input type="hidden" id="usuarioIdEdit">
                                <label for="usuarioNome">Nome:</label><input type="text" id="usuarioNome" required placeholder="Nome Completo">
                                <label for="usuarioEmail">E-mail (Login):</label><input type="email" id="usuarioEmail" required placeholder="email@exemplo.com">
                                <label for="usuarioSenha">Senha:</label><input type="password" id="usuarioSenha" required placeholder="Mínimo 6 caracteres">
                                <label for="usuarioRole">Nível de Acesso:</label>
                                <select id="usuarioRole" required>
                                    <option value="user">Usuário Comum</option>
                                    <option value="admin">Administrador</option>
                                </select>
                                <button type="submit" class="btn-primary">Salvar Usuário</button>
                                <button type="button" class="btn-secondary" id="cancelarEdicaoUsuario" style="display: none;">Cancelar Edição</button>
                            </form>
                            <h4 style="margin-top: 20px;">Usuários Cadastrados</h4>
                            <p id="usuariosLoadingMessage" class="data-load-status">Carregando usuários...</p>
                            <table id="usuariosAdminTable">
                                <thead>
                                    <tr><th>Nome</th><th>E-mail</th><th>Acesso</th><th>Ações</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>

                </main>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <script>
        // Configuração do Firebase (Substitua pelos seus dados)
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            databaseURL: "SUA_DATABASE_URL",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.database();
        const auth = app.auth();
        const ref = firebase.database.ref;
        const onValue = firebase.database.onValue;
        const set = firebase.database.set;
        const push = firebase.database.push;
        const remove = firebase.database.remove;

        // Variáveis de Cache
        let veiculosCache = {};
        let motoristasCache = {};
        let movimentacoesCache = {};
        let reservasCache = {};
        let loggedInUser = null;

        // --- Funções Auxiliares ---

        function showNotification(message, type = 'info') {
            const bar = document.getElementById('notification-bar');
            bar.textContent = message;
            bar.className = 'notification show ' + type;
            setTimeout(() => {
                bar.className = 'notification';
            }, 3000);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const options = { 
                year: 'numeric', month: 'numeric', day: 'numeric', 
                hour: '2-digit', minute: '2-digit'
            };
            return date.toLocaleDateString('pt-BR', options).replace(',', ' -');
        }

        function formatKM(km) {
            return km.toLocaleString('pt-BR');
        }
        
        // --- FUNÇÕES DE POPULAMENTO DE SELECTS E TABELAS ---

        /**
         * Popula os selects de motoristas.
         */
        function populateMotoristaSelects() {
            const selects = [document.getElementById('motoristaRetirada'), 
                             document.getElementById('motoristaReserva')];
            
            selects.forEach(select => {
                select.innerHTML = '<option value="">Selecione o Motorista</option>';
            });

            const motoristasArray = Object.values(motoristasCache);
            motoristasArray.sort((a, b) => a.nome.localeCompare(b.nome));

            motoristasArray.forEach(motorista => {
                selects.forEach(select => {
                    const option = document.createElement('option');
                    option.value = motorista.id;
                    option.textContent = motorista.nome;
                    select.appendChild(option);
                });
            });
        }

        /**
         * Popula os selects de veículos.
         * Aplica a lógica de visualização simplificada/admin.
         */
        function populateVeiculoSelects() {
            const selectRetirada = document.getElementById('veiculoRetirada');
            const selectDevolucao = document.getElementById('veiculoDevolucao');
            const selectReserva = document.getElementById('veiculoReserva');

            // Limpa todos os selects
            selectRetirada.innerHTML = '<option value="">Selecione o Veículo</option>';
            selectDevolucao.innerHTML = '<option value="">Selecione o Veículo</option>';
            selectReserva.innerHTML = '<option value="">Selecione o Veículo</option>';

            const veiculosArray = Object.values(veiculosCache);
            veiculosArray.sort((a, b) => a.modelo.localeCompare(b.modelo));

            veiculosArray.forEach(veiculo => {
                const isDisponivel = veiculo.status === 'Disponível';
                const isEmUso = veiculo.status === 'Em Uso';
                const isReservavel = veiculo.status !== 'Manutenção'; // Considera Disponível ou Em Uso (para saber se vai poder ser reservado)

                // 1. SELECT RETIRADA (Apenas Disponíveis)
                if (isDisponivel) {
                    const option = document.createElement('option');
                    option.value = veiculo.id;
                    // Exibir apenas Modelo e Placa, sem KM
                    option.textContent = `${veiculo.modelo} - ${veiculo.placa}`;
                    selectRetirada.appendChild(option);
                }

                // 2. SELECT DEVOLUÇÃO (Apenas Em Uso)
                if (isEmUso) {
                    const option = document.createElement('option');
                    option.value = veiculo.id;

                    let motoristaNome = 'Motorista Desconhecido';
                    // Busca a movimentação ativa para pegar o nome do motorista
                    const movAtiva = Object.values(movimentacoesCache).find(m => m.veiculoId === veiculo.id && m.tipo === 'Retirada' && !m.dataHoraFim);
                    if (movAtiva && motoristasCache[movAtiva.motoristaId]) {
                        motoristaNome = motoristasCache[movAtiva.motoristaId].nome;
                    }

                    // Lógica Admin: se for admin, mostra quem está com o carro
                    if (loggedInUser && loggedInUser.role === 'admin') {
                         option.textContent = `${veiculo.modelo} - ${veiculo.placa} (C/ ${motoristaNome})`;
                    } else {
                         option.textContent = `${veiculo.modelo} - ${veiculo.placa}`;
                    }

                    selectDevolucao.appendChild(option);
                }

                // 3. SELECT RESERVA (Disponível ou Em Uso/Reservável)
                if (isReservavel) {
                     const option = document.createElement('option');
                     option.value = veiculo.id;
                     option.textContent = `${veiculo.modelo} - ${veiculo.placa} (${veiculo.status})`;
                     selectReserva.appendChild(option);
                }
            });
        }

        // --- Funções de Eventos e Lógicas ---
        
        /**
         * Trata a seleção do veículo para Retirada
         */
        function handleVeiculoRetiradaChange() {
            const veiculoId = document.getElementById('veiculoRetirada').value;
            const infoCard = document.getElementById('veiculoInfoRetirada');
            const kmDisplay = document.getElementById('infoKmUltimaDevolucao');
            const combustivelDisplay = document.getElementById('infoCombustivelUltimaDevolucao');
            const kmAtualInput = document.getElementById('kmAtual');

            if (!veiculoId) {
                infoCard.style.display = 'none';
                kmDisplay.textContent = 'N/A';
                combustivelDisplay.textContent = 'N/A';
                kmAtualInput.placeholder = 'Informe o KM atual';
                kmAtualInput.min = 0;
                return;
            }

            // 1. Buscar última movimentação (Devolução)
            const ultMov = Object.values(movimentacoesCache)
                                .filter(m => m.veiculoId === veiculoId && m.tipo === 'Devolução')
                                .sort((a, b) => b.dataHoraFim - a.dataHoraFim)[0];

            let lastKm = veiculosCache[veiculoId] ? veiculosCache[veiculoId].kmAtual : 0;
            let lastCombustivel = 'N/A';

            if (ultMov) {
                lastKm = ultMov.kmFim;
                lastCombustivel = ultMov.combustivelFim;
            } else {
                // Se não houver devolução, pega do cadastro inicial do veículo
                lastCombustivel = 'Desconhecido';
            }

            // 2. Atualiza o Card
            kmDisplay.textContent = formatKM(lastKm);
            combustivelDisplay.textContent = lastCombustivel;
            infoCard.style.display = 'block';

            // 3. Atualiza o campo KM Atual (placeholder e validação)
            // A informação está no card, então apenas ajusta a validação
            kmAtualInput.placeholder = `Informe o KM atual (Último: ${formatKM(lastKm)})`;
            kmAtualInput.min = lastKm;
            kmAtualInput.value = ''; // Limpa para o usuário digitar
        }

        /**
         * Trata a seleção do veículo para Devolução
         */
        function handleVeiculoDevolucaoChange() {
            const veiculoId = document.getElementById('veiculoDevolucao').value;
            const infoCard = document.getElementById('veiculoInfoDevolucao');
            const motoristaDisplay = document.getElementById('infoMotoristaRetirada');
            const kmDisplay = document.getElementById('infoKmRetirada');
            const combustivelDisplay = document.getElementById('infoCombustivelRetirada');
            const kmDevolucaoInput = document.getElementById('kmDevolucao');

            if (!veiculoId) {
                infoCard.style.display = 'none';
                motoristaDisplay.textContent = 'N/A';
                kmDisplay.textContent = 'N/A';
                combustivelDisplay.textContent = 'N/A';
                kmDevolucaoInput.placeholder = 'Informe o KM atual';
                kmDevolucaoInput.min = 0;
                return;
            }

            // 1. Buscar movimentação de Retirada ATIVA
            const movAtiva = Object.values(movimentacoesCache)
                                .find(m => m.veiculoId === veiculoId && m.tipo === 'Retirada' && !m.dataHoraFim);

            if (!movAtiva) {
                 // Não deveria acontecer se o status for 'Em Uso', mas é uma segurança
                infoCard.style.display = 'block';
                motoristaDisplay.textContent = 'ERRO: Retirada não encontrada.';
                kmDisplay.textContent = 'N/A';
                combustivelDisplay.textContent = 'N/A';
                kmDevolucaoInput.placeholder = 'Informe o KM atual';
                kmDevolucaoInput.min = 0;
                return;
            }

            // 2. Encontrar nome do motorista
            const motorista = motoristasCache[movAtiva.motoristaId] ? motoristasCache[movAtiva.motoristaId].nome : 'Desconhecido';

            // 3. Atualiza o Card
            motoristaDisplay.textContent = motorista;
            kmDisplay.textContent = formatKM(movAtiva.kmInicio);
            combustivelDisplay.textContent = movAtiva.combustivelInicio;
            infoCard.style.display = 'block';

            // 4. Atualiza o campo KM Atual (placeholder e validação)
            kmDevolucaoInput.placeholder = `Informe o KM atual (Retirada em: ${formatKM(movAtiva.kmInicio)})`;
            kmDevolucaoInput.min = movAtiva.kmInicio + 1; // Deve ser estritamente maior
            kmDevolucaoInput.value = ''; // Limpa para o usuário digitar
        }

        // --- Inicialização e Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // Adiciona listeners para Selects
            document.getElementById('veiculoRetirada').addEventListener('change', handleVeiculoRetiradaChange);
            document.getElementById('veiculoDevolucao').addEventListener('change', handleVeiculoDevolucaoChange);
        });

        // O restante do código, incluindo a função de autenticação, listeners do Firebase, e as funções de cadastro/edição/deleção, permanecem como estão no arquivo original (codigo1.txt), com as devidas chamadas às novas funções de populamento.
        // A principal mudança está na função populateVeiculoSelects e nos event listeners de mudança (handleVeiculoRetiradaChange/handleVeiculoDevolucaoChange).
        
        // ... (O restante do seu código JavaScript, incluindo a inicialização do Firebase, autenticação, loadData e demais lógicas de formulário e tabela deve seguir aqui) ...
        
        // Exemplo da função loadData (Mantenha a sua, certificando-se que chama as novas funções)
        function loadData() {
            // Motoristas
            onValue(ref(db, 'usuarios'), (snapshot) => {
                motoristasCache = {};
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    motoristasCache[childSnapshot.key] = { id: childSnapshot.key, ...user };
                });
                populateMotoristaSelects();
                populateVeiculoSelects(); // Chamar aqui também, pois depende dos motoristas
            }, (error) => {
                showNotification('Erro ao carregar motoristas: ' + error.message, 'error');
            });
            
            // Veiculos
            onValue(ref(db, 'veiculos'), (snapshot) => {
                veiculosCache = {};
                snapshot.forEach(childSnapshot => {
                    veiculosCache[childSnapshot.key] = { id: childSnapshot.key, ...childSnapshot.val() };
                });
                populateVeiculoSelects();
                renderStatusVeiculos();
                renderVeiculosAdminTable();
            }, (error) => {
                showNotification('Erro ao carregar veículos: ' + error.message, 'error');
            });

            // Movimentacoes
            onValue(ref(db, 'movimentacoes'), (snapshot) => {
                movimentacoesCache = {};
                snapshot.forEach(childSnapshot => {
                    movimentacoesCache[childSnapshot.key] = { id: childSnapshot.key, ...childSnapshot.val() };
                });
                populateVeiculoSelects();
                renderHistoricoTable();
            }, (error) => {
                showNotification('Erro ao carregar movimentações: ' + error.message, 'error');
            });

            // Reservas
            onValue(ref(db, 'reservas'), (snapshot) => {
                reservasCache = {};
                snapshot.forEach(childSnapshot => {
                    reservasCache[childSnapshot.key] = { id: childSnapshot.key, ...childSnapshot.val() };
                });
                renderReservasTable();
            }, (error) => {
                showNotification('Erro ao carregar reservas: ' + error.message, 'error');
            });
            
            // ... (restante do loadData, como carregamento de usuários, etc.) ...
        }


        // ... (resto do código JS, incluindo funções de manipulação de formulários, renderização de tabelas, autenticação, etc., conforme seu arquivo original) ...

    </script>
</body>
</html>
